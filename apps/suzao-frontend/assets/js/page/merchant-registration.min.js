addEventListener("load",()=>{"PC"!==suzao.userAgent&&($axios.defaults.headers["Client-Type"]=2);const e=(e,t,i)=>new QRCode("QRCode",{text:e,errorCorrectionLevel:"H",version:2,width:158,height:158}),t=0,i=1,r=2,s=4,a=5,o={id:"",surname:"",fame:"",gender:"1",companyname:"",cellphone:"",businessLicence:"",contactEmail:"",invitationCode:"",companyFullAddress:"",ticketName:"",ticketRegistrationNo:"",ticketBankDeposit:"",ticketAccount:"",ticketAddress:"",ticketPhone:"",moneyVerify:"",ticketExamineFields:[],ticketExamineInfo:"",enterprisePutStatus:1,ticketExamineStatus:0},n={key:"",cid:"",mid:"",category:"",rmb:"",usd:"",saleScopeArr:[]},c={mid:"",mfrsName:"",rmb:void 0,usd:void 0,baseId:"",uuid:"",gradeName:"",speciesName:"",trademark:""};let d="";const h={title:"牌号冲突提示",msg:"尊敬的用户非常抱歉，您选择的牌号已经被其他供应商买断，请选择其他牌号",button:"重新选择"},m=new Vue({el:"#merchant-registration",data:()=>({baseURL:"https://suzaov2.oss-cn-shenzhen.aliyuncs.com/enterprise/",params:suzao.paramObj(),enterprisePutStatus:s,merchantForm:suzao.deepClone(o),businessLicence:[],proxyCardUrl:[],ticketImageUrl:[],rulesMerchantForm:{surname:[{required:!0,trigger:"blur",message:"姓为必填"}],fame:[{required:!0,trigger:"blur",message:"名为必填"}],gender:[{required:!0,trigger:"blur",message:"性别为必填"}],companyname:[{required:!0,trigger:"blur",message:"公司名称为必填"}],businessLicence:[{required:!0,trigger:"change",message:"公司营业执照为必填"}],companyFullAddress:[{required:!0,trigger:"blur",message:"公司地址为必填"}]},isVerification:!0,checked:!1,countdownNum:5,submitForm:{agree:!1},rulesSubmitForm:{agree:[{required:!0,message:"您必须同意协议",trigger:"change"}]},btnText:"确认协议并支付",bindProductForm:suzao.deepClone(n),rulesBindProductForm:{saleScopeArr:[{required:!0,message:"绑定区域必选",trigger:"change"}],category:[{required:!0,message:"推广周期必选",trigger:"change"}],key:[{required:!0,message:"请选择牌号",trigger:"blur"}],cid:[{required:!0,message:"请选择种类",trigger:"change"}],mid:[{required:!0,message:"请选择制造商",trigger:"change"}],rmb:[{pattern:/^(([1-9]{1}\d{0,9})|(0{1}))(\.\d{1,2})?$/,message:"请输入合法的金额数字，最多两位小数",trigger:"blur"}],usd:[{pattern:/^(([1-9]{1}\d{0,9})|(0{1}))(\.\d{1,2})?$/,message:"请输入合法的金额数字，最多两位小数",trigger:"blur"}]},enterpriseMarketV2VO:Object.assign({},c),pay:"wx",QRCode:"",tipWarning:!1,visibleTip2:!1,visibleTip3:!1,visibleTip6:!1,dialogVisible:!1,errorVisibleData:Object.assign({},h),dialogImageUrl:"",initOptionsGetGoodsList:[],optionsGetGoodsList:[],initOptionsRegion:[],optionsRegion:[],optionsMfrsList:[],optionsSpeciesList:[],initOptionsMfrsList:[],initOptionsSpeciesList:[],client:void 0,aliOss:{},clientErrorIndex:0,orderDetail:{},wxTimer:null,preEnterOrder:{bindEnd:"",bindStart:"",preOrderNo:"",totalPrice:""},loading:!1,isEnterprise:void 0,toOrderErrorIndex:0}),created(){this.init()},watch:{"bindProductForm.saleScopeArr":{handler:function(e,t){this.getGoodsList(),this.createPreEnterOrder()}},"bindProductForm.category":{handler:function(e,t){this.createPreEnterOrder()}}},computed:{validityTime(){const e=this.optionsGetGoodsList.find(e=>e.id===this.bindProductForm.category);return e?e.validityTime:""}},filters:{formattedTime(e){if(!e)return"";try{return suzao.parseTime(e)}catch(t){return e}},daysSinceEpoch(e){if(!e)return"";try{return e/24/60/60/1e3}catch(t){return e}},join:e=>e&&Array.isArray(e)&&e.length?e.join(","):""},methods:{async init(){try{await this.authenticationOrder(),this.authentication()}catch(e){console.error(e)}},initQuery(){new URLSearchParams(this.params).toString()},authentication(){this.isEnterprise=localStorage.getItem("isEnterprise"),this.isEnterprise||(this.btnText="下一步（上传营业执照）")},async authenticationOrder(){let e=!1;this.params.orderNo&&(e=this.isParamsOrderNo(this.params.orderNo)),e||(this.getGoodsList(),await this.getRegion(),await this.getSpeciesList(),await this.getMfrsList()),this.params.uuid&&this.isParamsUuid(this.params.uuid)},async isParamsOrderNo(e){try{const{code:t,data:i={}}=await this.getOrderDetail(e);if(101===t){if("create"===i.status)return this.enterprisePutStatus=a,suzao.changeURLStatic({enterprisePutStatus:a}),this.orderDetail=i,this.getPay(e),1;if(i.bingGoodsPriceVOList&&i.bingGoodsPriceVOList.length)return this.bindProductForm.saleScopeArr=i.bindScopes,this.bindProductForm.key=i.bingGoodsPriceVOList[0].gradeName,this.bindProductForm.cid=i.bingGoodsPriceVOList[0].speciesId+"",this.bindProductForm.mid=i.bingGoodsPriceVOList[0].mid,this.bindProductForm.rmb=i.bingGoodsPriceVOList[0].rmb,this.bindProductForm.usd=i.bingGoodsPriceVOList[0].usd,Object.keys(c).map(e=>{this.enterpriseMarketV2VO[e]=i.bingGoodsPriceVOList[0][e]}),await this.getRegion(),this.getNotAvailableRegion({gradeId:i.bingGoodsPriceVOList[0].baseId,speciesId:this.bindProductForm.cid,mid:this.bindProductForm.mid}),this.getSpeciesList(),this.getMfrsList(),1}}catch(e){}console.error(error),suzao.changeURLStatic({orderNo:void 0})},isParamsUuid(e){const t={can_show:1,nd:1,lite:1,m:0,v:2,id:e};fetch("/plastic/detail?"+new URLSearchParams(t).toString(),{headers:{"x-requested-with":"XMLHttpRequest"}}).then(e=>e.json()).then(({info:e})=>{const t={p_base_cid:e.p_base_cid,p_base_mid:e.p_base_mid,zhname:e.zhname,enname:e.enname,p_base_id:e.id,uuid:e.uuid,p_base_gradeno:e.p_base_gradeno,sp_name:e.species_en,name:e.name};this.searchRelateGradeNoSelect(t)}).catch(console.error)},filterParams(e,t){const i={};return Object.entries(t).map(([t,r])=>{i[t]=e[t]||r}),i},itemQuerySearch(e,t){if(e.length<2)return t([]);var i=new URLSearchParams;i.append("key",e),fetch("/vendor/autocompleteAddress?act=company",{method:"POST",body:i}).then(e=>e.json()).then(({status:e,data:i})=>{if(1===e){if(0===i.length)return t([]);var r=i.map(e=>({value:e}));return t(r)}return t([])}).catch(e=>(console.error("Error:",e),t([])))},async handleSelect(e,t){const{result:i}=await this.getTaxCredit(e);if(i&&i.items&&i.items.length){const{name:e,idNumber:r}=i.items[0];"companyname"===t?(this.merchantForm[t]=e,this.merchantForm.ticketName=e,this.merchantForm.ticketRegistrationNo=r):"ticketName"===t&&(this.merchantForm.ticketName=e,this.merchantForm.ticketRegistrationNo=r)}else"companyname"===t&&(this.merchantForm.ticketName=e)},async getTaxCredit(e){try{const t=await fetch("http://open.api.tianyancha.com/services/open/m/taxCredit/2.0?keyword="+e,{headers:{Authorization:"c7034c44-e721-4f83-88b6-ad79dbcbdb69"}});return await t.json()}catch(e){console.error(e)}},beforeAvatarUpload(e){const t="image/jpeg"===e.type||"image/png"===e.type,i=e.size/1024/1024<10;return t||this.$message.error("上传头像图片只能是 png JPG 格式!"),i||this.$message.error("上传头像图片大小不能超过 10MB!"),t},async businessLicenceSubmitUpload(e){try{const t=await this.uploadFile(e.file);t&&(callRecognizeBankCard(this.baseURL+t,this.aliOss,e=>{e&&e.Data&&(this.merchantForm.companyname=e.Data.Name||"",this.merchantForm.companyFullAddress=e.Data.Address||"",this.merchantForm.ticketName=e.Data.Name||"",this.merchantForm.ticketAddress=e.Data.Address||"",this.merchantForm.ticketRegistrationNo=e.Data.RegisterNumber||"")}),this.merchantForm.businessLicence=this.baseURL+t,this.businessLicence.push({url:this.baseURL+t}),this.$refs.refMerchantForm&&this.$refs.refMerchantForm.validateField("businessLicence"))}catch(e){console.error(e),this.$message({typeof:"error",message:"识别失败，请提供清晰的营业执照照片!"})}},businessLicenceHandleRemove(e){this.merchantForm.businessLicence="",this.businessLicence=[]},proxyCardUrlHandleRemove(e){const t=this.proxyCardUrl.indexOf(e);-1!==t&&(this.proxyCardUrl.splice(t,1),this.merchantForm.proxyCardUrl.splice(t,1))},ticketImageUrlHandleRemove(e){this.merchantForm.ticketImageUrl="",this.ticketImageUrl=[]},async toMerchantForm(){if(this.tipWarning)return!1;if(!this.$refs.refBindProductForm)return!1;const e=await this.$refs.refBindProductForm.validate();return!!e&&(this.submitForm.agree?void(this.isEnterprise?this.toOrder():this.enterprisePutStatus=t):(this.isVerification=!0,this.visibleTip3=!0,this.countdown(),!1))},async toOrder(){const e=await this.setBindRegion();if(e)if(e.code)this.errorVisibleData=Object.assign({},e.errorVisibleData),this.visibleTip6=!0;else{suzao.changeURLStatic({orderNo:e.orderNo});const{code:t,data:i}=await this.getOrderDetail(e.orderNo);if(101===t&&(this.orderDetail=i,this.enterprisePutStatus=a,this.toOrderErrorIndex=0),"ali"===this.pay)return void this.goPay(e.payReturn);"wx"===this.pay&&setTimeout(()=>{this.goPay(e.payReturn)})}else this.toOrderErrorIndex<1?(this.toOrderErrorIndex++,await this.createPreEnterOrder(),await this.toOrder()):this.toOrderErrorIndex=0},async submitMerchantFormToOrder(){this.loading=!0;try{let e=await this.enterprisePutStatusSubmitForm();e?(this.merchantForm.id||(this.merchantForm.id=e),this.$message({type:"success",message:"提交成功！"}),this.toOrder()):this.$message({type:"error",message:"上传提交失败！"}),this.loading=!1}catch(e){this.loading=!1,console.error("发生错误:",e)}},async getPay(e){const t=e||suzao.paramObj("orderNo"),i=await this.payForOrderNo(t);return!(!i||!i.payReturn)&&(await this.goPay(i.payReturn),!0)},async goPay(t){if("wx"===this.pay&&("PC"===suzao.userAgent?this.QRCode=await e(t):this.QRCode=t),"ali"===this.pay){let e=document.getElementsByTagName("divform");e.length&&document.body.removeChild(e[0]);const i=document.createElement("divform");i.innerHTML=t,document.body.appendChild(i)}"PC"===suzao.userAgent&&("ali"===this.pay&&this.mobilePay(),this.polling())},tabPay(){this.pay="ali",this.getPay()},polling(){const e=suzao.paramObj("orderNo");class t{constructor(){this.startPolling()}async startPolling(){m.wxTimer=setTimeout(async()=>{const{code:t,data:i}=await m.getOrderDetail(e);101===t?(m.orderDetail=i,"create"===i.status?this.startPolling():(clearTimeout(m.wxTimer),m.wxTimer=null,location.href="/buy/success?orderNo="+e)):m.$message({type:"error",message:"支付失败！"})},2e3)}}m.wxTimer||new t,setTimeout(()=>{clearTimeout(m.wxTimer),location.reload()},18e4)},async enterprisePutStatusSubmitForm(){if(this.$refs.refMerchantForm){const e=await this.$refs.refMerchantForm.validate();if(!e)return!1;if(!this.submitForm.agree)return this.visibleTip3=!0,!1}try{const e={...this.merchantForm,enterprisePutStatus:r};e.ticketAccount=e.ticketAccount.split(/[\t\r\f\n\s]*/g).join("");const t=suzao.parseFormData(e),{code:i,data:s,msg:a}=await this.setSmallBusinessApplication(t);if(101===i)return s;console.error(a)}catch(e){console.error(e)}},async temporaryEnterprisePutStatusSubmitForm(){if(this.merchantForm.ticketExamineStatus<2&&this.merchantForm.enterprisePutStatus<3){const e={...this.merchantForm,enterprisePutStatus:i};e.ticketAccount=e.ticketAccount.split(/[\t\r\f\n\s]*/g).join("");const t=suzao.parseFormData(e),{code:r,data:s,msg:a}=await this.setSmallBusinessApplication(t);101===r&&s&&!this.merchantForm.id&&(this.merchantForm.id=s)}},async setBindRegion(){try{this.enterpriseMarketV2VO.rmb=Number(this.bindProductForm.rmb),this.enterpriseMarketV2VO.usd=Number(this.bindProductForm.usd);const e={saleScopeArr:this.bindProductForm.saleScopeArr,startDate:this.preEnterOrder.bindStart,endDate:this.preEnterOrder.bindEnd,preOrderNo:this.preEnterOrder.preOrderNo,payType:this.pay+"_pay",enterpriseMarketV2VOList:[{...this.enterpriseMarketV2VO}]},{code:t,data:i,...r}=await $axios({url:"/core/enterprise/bindRegion",method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(e)});if(101===t)return i;if(4010===t)return{code:t,errorVisibleData:r}}catch(e){console.error(e)}},countdown(){if(this.isEnterprise)return this.submitForm.agree=!0,this.checked=!0,void(this.countdownNum=0);this.countdownNum=5;const e=setInterval(()=>{this.visibleTip3||clearInterval(e),this.countdownNum--,this.submitForm.agree=!1,this.checked=!1,this.countdownNum<=0&&(clearInterval(e),this.submitForm.agree=!0,this.checked=!0)},1e3);this.$on("destroy",()=>{clearInterval(e)})},openTip3(e){e?(this.isVerification=!1,this.visibleTip3=!0,this.countdown()):(this.isVerification=!0,this.checked=!1)},btnAgreeAndContinue(){this.submitForm.agree=!0,this.visibleTip3=!1,this.isVerification&&this.toMerchantForm()},async searchRelateGradeNoSearch(e,t){if(d&&d.abort(),!this.bindProductForm.cid&&!this.bindProductForm.mid&&e.length<2)return t([]);try{const i=await this.searchRelateGradeNo(e);return this.tipWarning=!Boolean(i.length),t(i)}catch(e){return t([])}},async searchRelateGradeNoSelect(e){const t=this.optionsSpeciesList.find(t=>t.name===e.sp_name||e.p_base_cid&&t.id===e.p_base_cid),i=this.optionsMfrsList.find(t=>t.name===e.zhname||e.p_base_mid&&t.id===e.p_base_mid);void 0!==t&&void 0!==i&&(this.enterpriseMarketV2VO={mid:e.p_base_mid,mfrsName:e.zhname,baseId:e.p_base_id,uuid:e.uuid,gradeName:e.p_base_gradeno,speciesName:e.sp_name,trademark:e.name,speciesId:t.id},this.bindProductForm.cid=t.id,this.bindProductForm.mid=i.id,this.bindProductForm.key=e.p_base_gradeno,this.tipWarning=!1,this.$nextTick(()=>{this.$refs.refBindProductForm.clearValidate(["key","cid","mid"])}),this.getNotAvailableRegion({gradeId:e.p_base_id,speciesId:t.id,mid:i.id}))},async getNotAvailableRegion(e){const{code:t,data:i}=await $axios({url:"/core/enterprise/getNotAvailableRegion",method:"get",params:e});101===t&&(Array.isArray(i)&&i.length?(i.length===this.initOptionsRegion.length&&(this.errorVisibleData=Object.assign({},h),this.visibleTip6=!0),this.optionsRegion=this.initOptionsRegion.map(e=>{const t={...e};return t.disabled=i.includes(t.label),t}),this.bindProductForm.saleScopeArr=suzao.deepClone(n.saleScopeArr),this.$nextTick(()=>{this.$refs.refBindProductForm.clearValidate(["saleScopeArr"])})):this.optionsRegion=this.initOptionsRegion.map(e=>{const t={...e};return t}))},searchRelateGradeNoBlur(e){this.enterpriseMarketV2VO.gradeName!==e.target.value&&(this.tipWarning=!0)},async searchRelateGradeNo(e){if(d=new AbortController,!e&&!this.bindProductForm.key)return!1;const t={start:0,length:9999,draw:1,cond:1,page:1,key:e||this.bindProductForm.key};this.bindProductForm.cid&&(t.cid=this.bindProductForm.cid),this.bindProductForm.mid&&(t.mid=this.bindProductForm.mid);const{data:{search:i,data:r}}=await axios({url:"/core/plastic/searchRelateGradeNo",method:"get",params:t,signal:d.signal});return r.items&&r.items.length?(i&&i.species&&i.mfrs&&(this.optionsSpeciesList=i.species,this.optionsMfrsList=i.mfrs),r.items):(this.optionsSpeciesList=suzao.deepClone(this.initOptionsSpeciesList),this.optionsMfrsList=suzao.deepClone(this.initOptionsMfrsList),[])},async getSpeciesList(){const e=await fetch("/vendor/getSpeciesList?v=3"),t=await e.json();t&&(this.initOptionsSpeciesList=Object.entries(t).map(([e,t])=>({id:e,name:t})),this.optionsSpeciesList=suzao.deepClone(this.initOptionsSpeciesList))},async getMfrsList(){const e=await fetch("/vendor/getMfrsList"),{data:t}=await e.json();t&&(this.initOptionsMfrsList=t,this.optionsMfrsList=t)},async getGoodsList(){try{const{data:e}=await $axios({url:"/core/trade/getGoodsList",method:"get",params:{category:"bindEnterprise",scopes:this.bindProductForm.saleScopeArr.join(",")}});if(e){this.initOptionsGetGoodsList&&this.initOptionsGetGoodsList.length||(this.optionsGetGoodsList=e),this.optionsGetGoodsList=e||[];const t=e.find(e=>e.isDefault);t?this.bindProductForm.category=t.id:e[0]&&(this.bindProductForm.category=e[0].id)}}catch(e){console.error(e)}},async getRegion(){try{const{data:e}=await $axios({url:"/core/enterprise/getRegion",method:"get"});e&&(this.initOptionsRegion&&this.initOptionsRegion.length||(this.initOptionsRegion=e.map(e=>({label:e}))),this.optionsRegion=e.map(e=>({label:e})))}catch(e){console.error(e)}},async createPreEnterOrder(){if(this.bindProductForm.category)try{const{data:e,code:t}=await $axios({url:"/core/trade/createPreEnterOrder",method:"post",data:{scopes:this.bindProductForm.saleScopeArr,gradeId:this.enterpriseMarketV2VO.baseId,goodsIds:[this.bindProductForm.category]}});101===t?this.preEnterOrder=e:5002===t&&this.createPreEnterOrder()}catch(e){console.error(e)}},async getSmallBusinessApplication(){try{const{data:e}=await $axios({url:"/core/enterprise/getSmallBusinessApplication"});return e}catch(e){console.error(e)}},async setSmallBusinessApplication(e){try{return await $axios({url:"/core/enterprise/smallBusinessApplication",method:"POST",data:e})}catch(e){console.error(e)}},getOrderDetail:e=>$axios({url:"/core/trade/getOrderDetail",method:"get",params:{orderNo:e}}),async payForOrderNo(e){const t=new FormData;t.append("orderNo",e),t.append("payType",this.pay+"_pay");const{code:i,data:r}=await $axios({url:"/core/trade/payForOutTradeNo",method:"post",data:t});return 101===i&&r},handlePictureCardPreview(e){this.dialogImageUrl=e,this.dialogVisible=!0},async getSTSToken(){try{const e=await $axios({url:"/core/STSToken/getSTSToken",method:"get",headers:{"X-Requested-With":"XMLHttpRequest"}}),t={bucket:"suzaov2",region:"oss-cn-shenzhen",accessKeyId:e.data.accessKeyId,accessKeySecret:e.data.accessKeySecret,stsToken:e.data.securityToken,refreshSTSTokenInterval:36e5};return this.aliOss={accessKeyId:e.data.accessKeyId,accessKeySecret:e.data.accessKeySecret,securityToken:e.data.securityToken},new OSS(t)}catch(e){console.error(e)}},async uploadFile(e){try{this.client||(this.client=await this.getSTSToken());const{fileMd5:t,rcFile:i}=await suzao.md5Count(e);return await this.client.put(`enterprise/${t}${i.name}`,e),this.clientErrorIndex=0,`${t}${i.name}`}catch(t){this.clientErrorIndex<1?(this.clientErrorIndex++,this.client=void 0,this.uploadFile(e)):(this.clientErrorIndex=0,console.error(t),this.$message({type:"error",message:t.message||"文件上传失败，请刷新后重试！"}))}},mobilePay(){document.querySelector("divform form").submit()},validateTicketAccount(e){this.merchantForm.ticketAccount=e.replace(/[^\S\r\n]/g,"").replace(/(.{4})/g,"$1 ").trim()}}})});