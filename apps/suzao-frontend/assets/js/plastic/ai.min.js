addEventListener("load",()=>{var t=new Vue({el:"#app",data(){var t=this,e=function(e,s,i){t.showCorrectForm.suggestContent||t.showCorrectForm.suggestType.length||t.showCorrectForm.imagesUrl?(t.showCorrectForm.suggestContent&&t.showCorrectForm.suggestType.length&&t.showCorrectForm.imagesUrl||t.$refs.showCorrectForm.clearValidate(),i()):i(new Error("请至少填写一项"))};return{info:{company_logo:"https://cube.elemecdn.com/9/c2/f0ee8a3c7c9638a54940382568c9dpng.png",name:CHAT_TEXT.welcome},colorString:"",titleList:[],tipList:[],aiHomeQueryList:[],btn:{url:"",text:""},byShare:[],byKyeIds:[],showCorrectVisible:!1,initShowCorrectForm:{suggestContent:"",suggestType:[],operateType:2,imagesUrl:""},showCorrectForm:{},suggestSettingText:{title:[],radioList:[]},initShowCorrectRules:{suggestContent:[{trigger:"blur",message:"反馈内容不能为空",validator:e}],suggestType:[{trigger:"change",message:"反馈内容不能为空",validator:e}],imagesUrl:[{trigger:"change",message:"反馈内容不能为空",validator:e}]},showCorrectRules:{suggestContent:[{trigger:"blur",message:"反馈内容不能为空",validator:e}],suggestType:[{trigger:"change",message:"反馈内容不能为空",validator:e}],imagesUrl:[{trigger:"change",message:"反馈内容不能为空",validator:e}]},formData:{name:"",company:"",industry:"",supply:"",company_full_address:""},memberIndustry:[],viewLoading:!0,tipShow:!1,aiHistory:{pageNum:1,pageSize:10},aiHistoryLeft:{pageNum:1,pageSize:30},aiTotalEndLeft:!1,aiTotalEnd:!1,aiTotalLength:0,aiTotalLengthLeft:0,aiTotalLoadingLeft:!1,aiTotalLoading:!1,chatLoading:!1,transitionLoading:!1,scrollHeight:0,eventSource:null,isFloor:!0,chatList:[],recordList:[],typeList:{display:{type:"display",className:"plastic-content",htmlString:"",ansId:"",convId:"",transitionLoading:!1,answerType:"",ansResultType:""},llm:{type:"display",className:"text-message-content",htmlString:"",ansId:"",convId:"",transitionLoading:!1},question:{type:"display",className:"user text-message-content",htmlString:"",ansId:"",convId:"",transitionLoading:!1},init:{type:"init",className:"init-content",colorString:"",titleTip:"",title:"",tip:"",text:[],transitionLoading:!1},recommend:{type:"recommend",className:"recommend-content",htmlString:"",text:[],tip:""},feedback:{type:"feedback",className:"feedback-content",answerType:"",ansId:"",convId:"",isLike:!1,isDiss:!1,queryContent:"",total:0,ansResultType:"",length:0},form:{type:"form",className:"form-content",industry:!1,company:!1,name:!1,ansId:"",convId:""},business:{type:"business",className:"business-content",list:[],ansId:"",convId:""},compare:{type:"compare",className:"compare-content",code:"",spInfoList:"",ansId:"",convId:""},commodity:{type:"commodity",className:"commodity-content",ansId:"",convId:"",ansShowTips:"",commodityVOList:[]},replace:{type:"replace",className:"replace-content",ansId:"",convId:"",answerType:"",ansResultType:"",ansShowTips:"",ansShowType:"",foldingState:!1,ansLines:[]},replaceCompare:{type:"replace-compare",className:"replace-compare-content",queryContent:"",ansId:"",convId:"",ansResultType:"",ansShowType:"",uuid:"",firstItemLine:{}},formula:{type:"formula",className:"formula-content",ansId:"",convId:"",ansResultType:"",ansShowType:"",ansShowTips:"",formulas:[]}},allChatList:{},convId:0,ansId:0,search:"",nextToChatList:[],receive:null,params:suzao.paramObj(),client:void 0,accept:"image/jpeg,image/png",autocompleteClassName:"",compareList:JSON.parse(localStorage.getItem("compareList")||"[]"),compareMax:5,replaceObj:[],replaceListActive:{},replaceList:[]}},provide(){return{backBottom:this.backBottom,backBottom2:this.backBottom2,chatList:this.chatList,handleSearch:this.handleSearch,renderEnd:this.renderEnd,renderStart:this.renderStart,openShowCorrect:this.openShowCorrect,replaceFormList:this.replaceFormList,memberIndustry:this.memberIndustry,openBecomeDialog:this.openBecomeDialog,myRandom:this.myRandom,questionAgain:this.questionAgain,copyText:this.copyText,openReplaceDialog:this.openReplaceDialog,openList:this.openList}},created(){this.init()},mounted(){this.getByShare(),this.initEventListener()},watch:{},computed:{},filters:{myRandom:this.myRandom,toIndex:(t,e)=>t[e]},methods:{initEventListener(){const t=this.$refs.chatContent;t.addEventListener("click",t=>{const e=t.target,s=e.classList,i=e.parentElement,n=i.classList;s.contains("compareBtn")&&e.getAttribute("data-label")&&this.changeCompare(e),n.contains("compareBtn")&&i.getAttribute("data-label")&&this.changeCompare(i)},!1)},changeCompare(t){const e=t.getAttribute("data-label");if(this.compareList.includes(e))this.compareList=this.compareList.filter(t=>t!==e);else{if(!(this.compareList.length<this.compareMax))return this.$message.error("最多只能添加"+this.compareMax+"个对比"),!1;this.compareList.push(e)}this.handleCompareState(t)},removeCompare(t){const e=document.querySelectorAll(".chat-content .compareBtn");if(void 0!==t){const s=this.compareList.splice(t,1);for(let t=0;t<e.length;t++){const i=e[t],n=i.getAttribute("data-label");n===s[0]&&i.classList.remove("active")}}else{this.compareList=[];for(let t=0;t<e.length;t++){const s=e[t].classList;s.remove("active")}}},handleCompareState(t){const e=t.getAttribute("data-label"),s=t.classList.contains("active"),i=document.querySelectorAll(".chat-content .compareBtn");for(let t=0;t<i.length;t++){const n=i[t],a=n.getAttribute("data-label");a===e&&(s?n.classList.remove("active"):n.classList.add("active"))}},viewCompare(){if(this.compareList.length){const t=document.querySelectorAll(".chat-content .compareBtn");for(let e=0;e<t.length;e++){const s=t[e],i=s.getAttribute("data-label");this.compareList.includes(i)&&s.classList.add("active")}}},openBecomeDialog(t){if(window.openSettledDialog)return window.openSettledDialog(),!1},goLogin(){window.openLoginDialog?window.openLoginDialog():location.href="/login?refer="+location.pathname+encodeURIComponent(location.search)},init(){_SZ_HAS_LOGIN&&(this.getMember(),this.handleScrollLeft(),this.getSTSToken(),this.getSuggestSetting()),this.showCorrectForm=JSON.parse(JSON.stringify(this.initShowCorrectForm));try{this.getAiHomeQueryList().then(t=>{this.viewLoading=!1,this.params.question?(this.handleSearch({key:this.params.question}),this.params.question="",suzao.changeURLStatic(this.params,!0)):(t.forEach(t=>{if(1===t.type)this.aiHomeQueryList.push(t.content);else if(4===t.type)this.tipList.push(t.content);else if(8===t.type)this.titleList.push(t.content);else if(9===t.type){const e=t.content.split("-");2===e.length&&(this.colorString=` background: linear-gradient(228deg,rgba(${e[0]}) 0%, rgba(${e[1]}) 100%)`)}else 11===t.type&&(this.btn={content:t.content,url:t.url})}),this.initChatList())}).catch(function(t){console.error(t),this.viewLoading=!1})}catch(t){console.error(t),this.viewLoading=!1}},getSTSToken(){var t=this;return new Promise(function(e,s){$axios({url:"/core/STSToken/getSTSToken",method:"get",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(function(i){if(101===i.code){var n={bucket:"suzaov2",region:"oss-cn-shenzhen",accessKeyId:i.data.accessKeyId,accessKeySecret:i.data.accessKeySecret,stsToken:i.data.securityToken,refreshSTSTokenInterval:36e5};t.client=new OSS(n),e()}else s()}).catch(function(){s()})})},beforeUpload(t){var e=this;return new Promise(function(s,i){var n=e.accept.includes(t.type);n||(this.$message.error("只能上传jpg/png文件"),i());var a=t.size/1024/1024<6;a||(this.$message.error("上传图片大小不能超过 6MB!"),i()),s()})},submitUpload(t){const e=this.$refs.refUpload.uploadFiles;this.uploadAndDownloadFile(e[e.length-1].raw)},uploadAndDownloadFile(t){var e=this;this.client||this.getSTSToken(),this.client.put("suggestion/"+t.uid+t.name,t).then(function(t){e.showCorrectForm.imagesUrl=t.url}).then(function(t){}).catch(function(t){})},removeFile(t,e){this.showCorrectForm.imagesUrl=""},getMember(){var t=this;axios({url:"/member",method:"get",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(function(e){if(200===e.status){var s=e.data;s.need_login&&t.goLogin(),s.member&&(s.member.company_logo&&(t.info.company_logo="https://logo.bkt.17suzao.com/"+s.member.company_logo),s.member.industry||t.getMemberIndustry(),t.info.name?t.info.name=s.member.name:t.info.cellphone&&(t.info.name=t.hidePhone(t.info.cellphone)))}}).catch(function(t){})},hidePhone(t){const e=/(\d{3})\d{4}(\d{4})/;return String(t).replace(e,"$1****$2")},getSuggestSetting(){var t=this;$axios({url:"/core/dm/botAPI/getSuggestSetting",method:"get"}).then(function(e){101===e.code?e.data.forEach(function(e){2===e.type?t.suggestSettingText.radioList.push(e.content):3===e.type&&t.suggestSettingText.title.push(e.content)}):t.$message.error(e.msg)}).catch(function(t){})},getAiHomeQueryList(){return new Promise((t,e)=>{$axios({url:"/core/dm/botAPI/aiHomeQuery?num=12",method:"get"}).then(s=>{if(101===s.code)return t(s.data);this.$message.error(s.msg),e(s.msg)}).catch(function(t){e(t)})})},getMemberIndustry(){var t=this;this.memberIndustry.length||axios({url:"/vendor/getMemberIndustry"}).then(function(e){e.data&&1===e.data.status&&(t.memberIndustry=e.data.data)})},requestData(e,s,i){var n={id:e,num:s||1};this.byKyeIds.length&&(n.byKyeIds=this.byKyeIds.join(",")),i&&(n.key=i),$axios({url:"/core/adv2/getAdvertising?"+new URLSearchParams(n).toString(),method:"get"}).then(function(e){101===e.code?e.data.advertisingList.length&&(t.byShare=e.data.advertisingList.map(function(t){return t.image=JSON.parse(t.image),t.video=JSON.parse(t.video),t}),t.byKyeIds=e.data.byKyeIds):t.$message.error(e.msg)})},toLink:t=>t.link?t.link+(t.link.includes("?")?"&":"?")+"hash="+t.hash:t.has_content?"page/highlightV2?id="+t.id:"",getByShare(t){var e=parseInt(parseInt(getComputedStyle(this.$refs.recommend).height,10)/230,10);this.requestData(100008,e>4?4:e,t)},submitChat(t,e){if(""===this.search.trim()||this.chatLoading||this.nextToChatList.length||this.chatList.length&&"user text-message-content"===this.chatList[0].className||this.receive)return;const s={key:this.search.trim()};e?s.queryType=e:t.value&&void 0===e&&(s.queryType=3),this.handleSearch(s),this.search="",this.autocompleteClassName="popperClassName",this.$nextTick(this.backBottom2)},handleSearch(t){_SZ_HAS_LOGIN?this.chatLoading||this.nextToChatList.length||this.chatList.length&&"user text-message-content"===this.chatList[0].className||this.receive?console.error("错误"):(this.chatList.unshift(this.questionToComponentItem(t)),this.getEventSource(t.key,t.queryType,t.uuid)):this.goLogin()},querySearch(t,e){var s=this;if(""===s.search)return e([]);$axios({url:"/core/dm/botAPI/getSearchSuggest",method:"get",params:{queryKey:t}}).then(function(t){if(101===t.code){if(t.data&&t.data.length){var i=t.data.map(function(t){return{value:t}});if(s.search)return s.autocompleteClassName="",e(i)}}else s.$message.error(t.msg);return e([])}).catch(()=>e([]))},handleScrollLeft(){this.aiTotalEndLeft||this.getAiHistoryLeft()},handleScroll(t){var e=this.$refs.chatContent;0!==e.scrollTop||this.aiTotalLoading||this.aiTotalEnd||(this.getScrollHeight(this.$refs.chatContent),this.getAiHistory(this.restoreScrollPosition,!1)),this.isFloor=e.scrollHeight-e.scrollTop-30<e.clientHeight},getScrollHeight(t){this.scrollHeight=t.scrollHeight},restoreScrollPosition(e,s){this.jsonToHtmlString(e,s),this.$nextTick(function(){var e=t.$refs.chatContent;e.scrollTop=e.scrollHeight-t.scrollHeight})},jsonToHtmlString(t,e){0!==t.dataList.length?(e&&(this.chatList=[]),this.$nextTick(()=>{t.dataList.forEach(this.classification)})):this.initChatList(this.convId)},classification(t){const e=[],s=[],i=[],n=t.answerType&&t.answerType.trim(),a=t.contentType,o=t.ansId,r=t.convId,c=t.isDiss,h=t.isLike,l=t.queryContent;let d=t.answerContent,m=t.llmContent;const p="list",u="text",g="COMPARE",L="REPLACE02",v="FORMULA";try{d=JSON.parse(t.answerContent)}catch(t){console.error(t)}d.extraData&&"object"==typeof d.extraData&&(n===L?(this.setReplaceCompare(d.extraData,d.ansLines,d.total),i.push(this.jsonToComponentItem("replaceCompare",{ansId:o,convId:o,queryContent:l,answerType:d.answerType&&d.answerType.trim(),ansResultType:d.ansResultType&&d.ansResultType.trim(),...d.extraData}))):n===v&&e.unshift(this.jsonToComponentItem("formula",{ansId:o,convId:o,ansShowType:d.ansShowType,ansShowTips:d.ansShowTips,ansResultType:d.ansResultType&&d.ansResultType.trim(),...d.extraData})));let y=0;d.ansLines?y=d.ansLines.length:d.enterpriseInfoList&&(y=d.enterpriseInfoList.length);const f={ansId:o,convId:o,answerType:d.answerType&&d.answerType.trim(),ansResultType:d.ansResultType&&d.ansResultType.trim(),queryContent:l,total:d.total,length:y,isDiss:c,isLike:h};if(d.ansResultType===L&&d.extraData&&d.extraData.uuid&&(f.uuid=d.extraData.uuid),s.push(this.jsonToComponentItem("feedback",f)),m){const s=this.decodeSpaces(t.llmContent);m=this.jsonToComponentItem("display",{htmlString:marked(s),ansId:o,convId:r}),e.push(m)}let I=[];if((a===p||a===u&&d.ansResultType===g)&&(I=this.listToComponentItem(d)),Array.isArray(I))if(I.length>=2){const t=[];I.map(e=>{const s={...e};["commodity"].includes(e.type)?(s.className+=" overflow-x",i.push(s)):t.push(s)}),e.unshift(...t)}else e.unshift(...I);const T=this.questionToComponentItem({key:l,ansId:o,convId:r}),S=[];i.length&&S.push(...i),s.length&&S.push(...s.slice(-1)),e.length&&S.push(...e),S.push(T),this.chatList.push(...S),this.renderEnd()},getAiHistory(t,e){var s=this;return new Promise(function(i,n){s.convId||i();var a={convId:s.convId};for(var o in s.aiHistory)""!==s.aiHistory[o]&&(a[o]=s.aiHistory[o]);s.aiTotalLoading=!0,$axios({url:"/core/dm/botAPI/getLogByPage",method:"get",params:a}).then(function(a){if(s.aiTotalLoading=!1,101===a.code){s.aiHistory.pageNum++;var o=s.chatList.filter(function(t){return"user text-message-content"===t.className});s.aiTotalEnd=a.data.total<=o.length+a.data.dataList.length,t&&"function"==typeof t&&t(a.data,e),i()}else s.$message.error(a.msg),n()}).catch(function(t){s.aiTotalLoading=!1,s.$message.error(t.message),n()})})},getAiHistoryLeft(){this.aiTotalLoadingLeft=!0;var t=this,e={};for(var s in this.aiHistoryLeft)""!==this.aiHistoryLeft[s]&&(e[s]=this.aiHistoryLeft[s]);$axios({url:"/core/dm/botAPI/getConvByPage",method:"get",params:e}).then(function(e){t.aiTotalLoadingLeft=!1,t.aiHistoryLeft.pageNum++,101===e.code?(e.data.dataList.forEach(function(e){t.recordList.push(e)}),t.recordList.length===e.data.total&&(t.aiTotalEndLeft=!0)):t.$message.error(e.msg)}).catch(function(e){t.$message.error(e.message)})},backBottom(){this.isFloor&&this.$refs.chatContent&&(this.$refs.chatContent.scrollTop=this.$refs.chatContent.scrollHeight)},backBottom2(){this.$refs.chatContent&&this.$refs.chatContent.scrollTo({top:this.$refs.chatContent.scrollHeight+200,behavior:"smooth"})},getEventSource(t,e,s){const i=this,n="?key="+encodeURIComponent(t)+(this.convId?"&convId="+this.convId:"")+("number"==typeof e?"&queryType="+e:"")+(s?"&uuid="+s:"");this.transitionLoading=!0,this.ansId=0,this.eventSource=new EventSource("/core/dm/botAPI/v2"+n);const a=[],o=[],r=[],c=[];let h=!1;const l=e=>{const i=JSON.parse(e.data);this.addRecordList(i),this.chatList.filter(t=>{if(""===t.convId||""===t.ansId)return t.convId=i.convId,t.ansId=i.ansId,t}),i.supplement&&!h&&(this.addSupplement(i.supplement),h=!0);const n=this.listToComponentItem(i);if(Array.isArray(n))if(n.length>=2){const t=[];n.map(e=>{const s={...e};["commodity"].includes(e.type)?(s.className+=" overflow-x",c.push(s)):t.push(s)}),a.push(...t)}else a.push(...n);let r=0;i.ansLines?r=i.ansLines.length:i.enterpriseInfoList&&(r=i.enterpriseInfoList.length),o.push(this.jsonToComponentItem("feedback",{ansId:i.ansId,convId:i.convId,answerType:i.answerType&&i.answerType.trim(),ansResultType:i.ansResultType&&i.ansResultType.trim(),queryContent:t,total:i.total,length:r,uuid:s}));const l="REPLACE02",d="FORMULA",m=i.ansResultType&&i.ansResultType.trim();i.extraData&&"object"==typeof i.extraData&&(m===l?(this.setReplaceCompare(i.extraData,i.ansLines,i.total),c.push(this.jsonToComponentItem("replaceCompare",{ansId:i.ansId,convId:i.convId,answerType:i.answerType&&i.answerType.trim(),ansResultType:m,...i.extraData}))):m===d&&a.push(this.jsonToComponentItem("formula",{ansId:i.ansId,convId:i.convId,ansShowType:i.ansShowType,ansShowTips:i.ansShowTips,ansResultType:m,...i.extraData})))};let d=!1,m="",p="",u=1;const g=(t,e)=>{if(null!==i.receive){let s=null;const n=a=>{s||(s=a);const o=a-s;o>e&&t<=m.length&&(p+=m.slice(t-1,t),i.chatList[0].htmlString=marked(p),t++,setTimeout(i.backBottom,300),s=a),d||t<=m.length?i.receive=requestAnimationFrame(n):(i.receive=null,i.nextToChatList.length&&i.renderEnd())};i.receive=requestAnimationFrame(n)}},L=t=>{if(console.error(t),this.transitionLoading=!1,this.receive||m)d=!1,window.cancelAnimationFrame(this.receive);else try{const s=JSON.parse(t.data);if(s&&5007===s.code){this.$message({type:"error",message:s.msg,customClass:"z-index-max"}),window.openMemberInterest();var e=Object.assign({},this.typeList.llm,{htmlString:'<p class="text open-member-interest">'+(s.msg||CHAT_TEXT.error)+"</p>",ansId:this.ansId,convId:this.convId});this.chatList.unshift(e)}}catch(s){e=Object.assign({},this.typeList.llm,{htmlString:'<p class="text">'+(t.data||CHAT_TEXT.error)+"</p>",ansId:this.ansId,convId:this.convId});this.chatList.unshift(e)}this.eventSource.close()},v=t=>{r.push(t.data)},y=t=>{const e=[];if(a.length&&e.push(...a),o.length&&e.push(...o.slice(-1)),r.length){const t=this.jsonToComponentItem("recommend",{text:suzao.deepClone(r),tip:CHAT_TEXT.recommend,ansId:this.ansId,convId:this.convId});e.push(t)}c.length&&e.push(...c),d&&(d=!1),h?(m&&(e.unshift(this.jsonToComponentItem("display",{ansResultType:"LLM",answerType:"text",htmlString:marked(m),ansId:this.ansId,convId:this.convId})),o.length||e.push(this.jsonToComponentItem("feedback",{ansResultType:"LLM",answerType:"text",ansId:this.ansId,convId:this.convId}))),this.receive&&this.closeChat()):this.nextToChatList.push(...e),this.transitionLoading=!1,this.eventSource.close(),this.receive||this.renderEnd()};this.eventSource.addEventListener("ES",l),this.eventSource.addEventListener("NL2SQL",l),this.eventSource.addEventListener("FUZZY_QUERY",l),this.eventSource.addEventListener("ENTERPRISE",l),this.eventSource.addEventListener("COMPARE",l),this.eventSource.addEventListener("BRL",l),this.eventSource.addEventListener("COMMODITY",l),this.eventSource.addEventListener("REPLACE01",l),this.eventSource.addEventListener("REPLACE02",l),this.eventSource.addEventListener("FORMULA",l),this.eventSource.addEventListener("satisfactionSurvey",t=>{}),this.eventSource.addEventListener("SYSTEM_ERROR",L),this.eventSource.addEventListener("error",L),this.eventSource.addEventListener("103",t=>{L(t),this.goLogin()}),this.eventSource.addEventListener("RECOMMEND",v),this.eventSource.addEventListener("ansId",t=>{this.ansId=Number(t.data),this.chatList.filter(t=>{if(""===t.ansId)return t.ansId=this.ansId,t})}),this.eventSource.addEventListener("convId",t=>{this.addRecordList({convId:Number(t.data)}),this.chatList.filter(t=>{if(""===t.convId)return t.convId=this.convId,t})}),this.eventSource.addEventListener("supplement",t=>{h||(this.addSupplement(t.data),h=!0)}),this.eventSource.addEventListener("LLM",t=>{""!==m||d||(h?y():(d=!0,this.transitionLoading=!1,this.chatList.unshift(this.jsonToComponentItem("display",{ansResultType:"LLM",ansShowType:"text",htmlString:"",ansId:this.ansId,convId:this.convId})),o.push(this.jsonToComponentItem("feedback",{ansResultType:"LLM",answerType:"text",ansId:this.ansId,convId:this.convId})),this.receive=0,g(u,16))),m+=t.data,m=this.decodeSpaces(m)}),this.eventSource.addEventListener("end",y)},addSupplement(t){const e={ansId:t.ansId,convId:t.convId};var s=t.split(",");s.includes("1")&&(e.industry=!0),s.includes("2")&&(e.company=!0),s.includes("3")&&(e.name=!0);const i=this.jsonToComponentItem("form",e);this.nextToChatList.push(i)},closeEventSource(){this.eventSource&&this.eventSource.close(),this.chatLoading=!1},closeChat(){this.closeEventSource(),this.transitionLoading?(this.nextToChatList.push(this.jsonToComponentItem("display",{htmlString:"已停止回答",ansId:this.ansId,convId:this.convId})),this.nextToChatList.push(this.jsonToComponentItem("feedback",{ansId:this.ansId,convId:this.convId}))):this.receive&&(0===this.nextToChatList.length&&this.nextToChatList.push(this.jsonToComponentItem("feedback",{ansResultType:"LLM",answerType:"text",ansId:this.ansId,convId:this.convId})),window.cancelAnimationFrame(this.receive),this.receive=null),this.transitionLoading=!1,this.nextTickChatList()},initChatList(t){this.chatList=[],this.viewLoading=!1,this.aiTotalEnd=!0,this.ansId="",this.convId=t||"",this.isFloor=!0;var e=this.jsonToComponentItem("init",{colorString:this.colorString,titleTip:this.myRandom(this.titleList,1),title:this.myRandom(this.tipList,1),text:suzao.deepClone(this.aiHomeQueryList),tip:CHAT_TEXT.recommend,btn:this.btn});this.nextToChatList.push(e),this.nextTickChatList()},addRecordList(t){if(""===this.convId){var e=this.chatList.find(function(t){if("user text-message-content"===t.className)return!0});this.convId=t.convId,this.recordList.unshift({convTitle:this.stripHtmlTags(e.htmlString),convId:t.convId})}},myRandom(t,e){for(var s=[],i=JSON.parse(JSON.stringify(t)),n=0;n<e;n++){var a=Math.floor(Math.random()*i.length),o=i[a];s.push(o),i.splice(a,1)}return 1===e?s[0]:s},stripHtmlTags:t=>t.replace(/<[^>]*>/g,""),decodeSpaces(t){try{return t.replace(/&lt;br&gt;/g,"\t\n\t\n").replace(/&nbsp;/g," ")}catch(e){return t}},listToComponentItem(t){const e=this,s=t.ansResultType,i=t.ansLines,n=t.enterpriseInfoList,a=t.compareInfo,o=t.commodityVOList,r=suzao.arrayToObjectByKey(t.recommendedSmallBusiness,"uuid"),c=[];if(i){const n={};["REPLACE01"].includes(s)?Object.entries(this.typeList.replace).forEach(([e,s])=>{n[e]="ansLines"===e?i:t[e]?t[e]:s}):Object.entries(this.typeList.display).forEach(([s,a])=>{"htmlString"===s?n.htmlString=e.listToHtml(i,t.ansShowTips||CHAT_TEXT.list,r):n[s]=t[s]?t[s]:a}),c.push(n)}if(n){const e={};Object.entries(this.typeList.business).forEach(function(s){var i=s[0],a=s[1];e[i]="list"===i?n.map(function(t){return t}):t[i]?t[i]:a}),c.push(e)}if(a){const e={};Object.entries(this.typeList.compare).forEach(function(s){var i=s[0],n=s[1];e[i]="code"===i?a.code:"spInfoList"===i?a.spInfoList.join(","):t[i]?t[i]:n}),c.push(e)}if(o){const e={};Object.entries(this.typeList.commodity).forEach(function(s){var i=s[0],n=s[1];e[i]=t[i]?t[i]:n}),c.push(e)}return c},listToHtml(t,e,s){if(!Array.isArray(t))return"";let i='<div class="tip">'+e+"</div>";return t.find((t,e)=>{const n={uuid:t.lineUuId,dataPlasticId:t.pBaseId};if(t.firstItemLine&&t.firstItemLine.length>0&&(i+='<a href="/plastic/detail?id='+t.lineUuId+'" target="_blank" class="title">',t.firstItemLine.forEach(function(t){t.itemValue&&(n[t.itemLabel]=t.itemValue,i+=t.itemValue)}),i+="</a>"),t.secondItemLine&&t.secondItemLine.length>0&&(i+='<div class="details">',t.secondItemLine.forEach(function(t){t.itemValue&&(i+=suzao.escapeHtml(t.itemValue))}),i+="</div>"),t.thirdItemLine&&t.thirdItemLine.length>0){i+='<div class="info">';let e=!1;t.thirdItemLine.forEach(function(t){if(t.itemValue){let s="",a=suzao.escapeHtml(t.itemValue),o="";"\n"===t.itemClass&&(o=" \n"),e&&(s+="\n"),"unit_price"===t.itemLabel&&"价格询购"===a&&(e=!0),"cellphone"===t.itemLabel&&(n[t.itemLabel]=suzao.formatPhone(a)),(["market_id","cellphone"].includes(t.itemLabel)||e&&"unit"===t.itemLabel)&&(a=""),e&&"unit"===t.itemLabel&&(e=!1),i+=s+a+o}}),i+="</div>"}let a="";s[t.lineUuId]&&(s[t.lineUuId].find(e=>{if(e.uuid===t.lineUuId)return n.enterpriseId=e.enterpriseId}),a=this.recommendedSmallBusinessHtml(s,t));const o=this.compareHTML(n),r=this.cellphoneHTML(n),c='<div class="feedback">'+r+o+a+"</div>";i+=c}),i+="</div>",i},compareHTML(t){if(!t.uuid)return"";const e=`${t.uuid}|${t.sp_name} ${t.p_base_gradeno}`;let s="";return this.compareList.length&&this.compareList.includes(e)&&(s="active"),`<span class="compareBtn ${s}" data-label="${e}">\n          <span class="join">物性对比</span>\n          <span class="cancel">取消对比</span>\n        </span>`},cellphoneHTML(t){if(!t.cellphone)return"";const e=suzao.formatPhone(t.cellphone),s=t.uuid,i=t.dataPlasticId,n=t.enterpriseId;return`<span class="formatPhone smallBusinessObserver" \n                  data-sensors-click\n                  data-plastic-id="${i}"\n                  data-enterprise-id="${n}"\n                  data-id="${s}"\n                  data-phone="${e}">\n                  <i class="iconfont icon-icon_dianhua"></i>查看电话\n                </span>`},priceHTML(t){let e="";return t.rmb&&(e+=`<strong>含税CNY ${t.rmb}/吨</strong>`),t.usd&&(e+=`<strong>USD ${t.usd}/吨</strong>`),t.rmb||t.usd||(e+="<strong>价格询购</strong>"),e},companyHTML:t=>t.companyname?t.type?`<span>${t.type}: </span>${t.companyname}`:`${t.companyname}`:"",recommendedSmallBusinessHtml(t,e){let s="";const i=e.lineUuId,n=e.pBaseId;for(let e=0;e<t[i].length;e++){const a=t[i][e],o=this.priceHTML(a),r=this.companyHTML(a),c=this.cellphoneHTML({...a,dataPlasticId:n});s+=`<div class="li">\n            <div class="left">\n              <div class="price">${o}</div>\n              <div class="company">${r}</div>\n            </div>\n            <div class="right">\n              <div class="others">${c}</div>\n            </div>\n          </div>`}return`<span class="recommendedSmallBusinessBtn">\n         <div class="box"><img src="/frontend/assets/ai/icon-company.png" alt=""> <span class="red">${t[i].length}</span>个商家 <i class="el-icon-arrow-right"></i></div>\n         <div class="cont-box">${s}</div>\n        </span>`},questionToComponentItem(t){const e=this.jsonToComponentItem("question",t||{});return e.htmlString='<p class="text">'+e.key+"</p>",e},jsonToComponentItem(t,e){return Object.assign({},this.typeList[t],e||{})},openShowCorrect(t){var e=this;this.showCorrectVisible=!0,t?(this.showCorrectRules={},this.showCorrectForm.ansId=t):this.showCorrectRules=this.initShowCorrectRules,this.$nextTick(function(){e.$refs.showCorrectForm&&e.$refs.showCorrectForm.clearValidate()})},showCorrectOnSubmit(){var t=this;this.$refs.showCorrectForm.validate(function(e){if(e){var s={};Object.entries(t.showCorrectForm).forEach(function(t){var e=t[0],i=t[1];"suggestType"===e?i.length&&(s[e]=i.join(",")):i&&(s[e]=i)}),$axios({url:"/core/dm/botAPI/likeOrDis",method:"post",data:s}).then(function(e){101===e.code?(t.$message({type:"success",message:"感谢你的反馈"}),t.showCorrectVisible=!1,t.showCorrectForm.ansId&&t.chatList.find(function(e){if(e.ansId===t.showCorrectForm.ansId&&"feedback"===e.type)return e.isDiss=!0,e.isLike=!1,!0}),t.showCorrectForm=JSON.parse(JSON.stringify(t.initShowCorrectForm))):t.$message.error(e.msg)}).catch(function(e){t.$message.error(e.message)})}})},closeFeedbackDialog(){this.showCorrectForm.ansId?this.showCorrectOnSubmit():this.showCorrectForm=JSON.parse(JSON.stringify(this.initShowCorrectForm))},tabChatContent(t){var e=this;if(t!==this.convId){if(this.viewLoading=!0,this.closeChat(),this.allChatList[this.convId]={chatList:suzao.deepClone(this.chatList),aiHistory:suzao.deepClone(this.aiHistory),aiTotalEnd:this.aiTotalEnd,aiTotalLength:this.aiTotalLength},t)if(this.recordConvId(t),this.allChatList[t]){var s=suzao.deepClone(this.allChatList[t]);this.chatList=s.chatList,this.aiHistory=s.aiHistory,this.aiTotalEnd=s.aiTotalEnd,this.aiTotalLength=s.aiTotalLength,e.viewLoading=!1,e.$nextTick(()=>{e.backBottom2(),suzao.observer.call(suzao,2)})}else this.aiHistory.pageNum=1,this.aiTotalEnd=!1,this.aiTotalLength=0,this.getAiHistory(this.jsonToHtmlString,!0).then(()=>{e.viewLoading=!1,e.$nextTick(()=>{e.backBottom2(),suzao.observer.call(suzao,2)})});else this.initChatList();setTimeout(this.viewCompare)}},removeConvId(t,e){var s=this,i=new FormData;t&&i.append("convId",t),$axios({url:"/core/dm/botAPI/removeConvId",method:"post",data:i}).then(function(i){101===i.code?(s.$message({type:"success",message:"删除成功"}),void 0!==e?(s.recordList.splice(e,1),t===s.convId&&s.initChatList()):void 0===t&&(s.recordList=[],s.initChatList())):s.$message({type:"error",message:"删除失败"})}).catch(function(t){s.$message.error(t.message)})},recordConvId(t){this.convId=t},recordAnsId(t){this.ansId=t},renderStart(){this.chatLoading=!0},renderEnd(){this.chatLoading=!1,this.nextTickChatList()},nextTickChatList(){if(this.nextToChatList.length){var t=this.nextToChatList.shift();t&&this.chatList.unshift(t)}},replaceFormList(){var t=this;this.allChatList={},this.aiHistory.pageNum=1,this.aiTotalEnd=!1,this.getAiHistory(this.jsonToHtmlString,!0).then(function(){t.$nextTick(t.backBottom2)})},questionAgain(t,e){let s="";const i=this.chatList.filter(function(s){return s.ansId===t&&s.conId===e});i.at(-1).key&&(s=i.at(-1).key),i.length&&s&&(this.chatList.splice(0,i.length),setTimeout(()=>{this.handleSearch({key:s,queryType:0})}))},copyText(t){},openList(t,e){const s=this.chatList.find(s=>s.ansId===t&&s.conId===e&&"REPLACE01"===s.ansResultType&&"list"===s.ansShowType);s&&(s.foldingState=!s.foldingState)},closeReplaceDialog(){this.replaceListActive={},this.replaceList=[]},openReplaceDialog(t){const e=this.replaceObj[t.uuid];if(e&&"object"==typeof e&&e.replaceList.length===e.total)return this.replaceListActive=e.replaceListActive,this.replaceList=e.replaceList,!0;this.getSuccess(t)},setReplaceCompare(t,e,s){const i=t.uuid;if(i){const n=e.map(t=>{const e={};return t.firstItemLine&&t.firstItemLine.filter(t=>{e[t.itemLabel]=t.itemValue}),{firstItemLine:e,uuid:t.lineUuId}});this.replaceObj[i]={replaceListActive:suzao.deepClone(t),replaceList:n,total:s}}},getSuccess(t){const e={};try{e.key=decodeURIComponent(t.queryContent)}catch(s){e.key=t.queryContent}e.ansResultType=t.ansResultType,e.ansId=t.ansId,e.convId=t.convId,e.uuid=t.uuid,e.pageNum=1,e.pageSize=1e3;const s=new EventSource("/core/dm/botAPI/v2?"+new URLSearchParams(e).toString()),i=this.replaceObj[t.uuid];s.addEventListener("REPLACE02",e=>{const{data:n}=JSON.parse(e.data);n&&n.items&&n.items.length&&(this.replaceObj[t.uuid]={replaceListActive:i.replaceListActive,replaceList:n.items,total:n.total}),this.replaceListActive=i.replaceListActive,this.replaceList=n.items,s&&s.close()})}}})}),window.addEventListener("error",t=>{console.error(t,"error")}),window.addEventListener("unhandledrejection",t=>{console.error(t,"unhandledrejection")});